<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
        media="screen,projection" />
    <link type="text/css" rel="stylesheet" href="index.css" />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tiny Game</title>
</head>

<body>
    <nav class="nav-extended">
        <div class="nav-wrapper cyan lighten-1">
            <a href="#!" class="brand-logo center">Tiny Game</a>
        </div>
        <div class="nav-content cyan lighten-3">
            <ul class="tabs tabs-transparent">
                <li class="tab">
                    <a id="mainButton" href="javascript:void(0)" class="white-text">
                        主页
                    </a>
                </li>
                <li class="tab">
                    <a id="rankButton" href="javascript:void(0)" class="white-text">
                        排行榜
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div id="rank" class="container" style="display: none">
    
    </div>

    <div id="main" class="container" style="display: block">
        <div class="row">
            <div class="col s6">
                <h3 class="flow-text center blue-grey-text text-lighten-1">
                    当前玩家
                </h3>
                <ul class="collection" id="user-list">

                </ul>
            </div>
            <!-- fighting area -->
            <div id="fighting-area" class="col s6" style="display: none">
                <h3 class="flow-text center blue-grey-text text-lighten-1">
                    对战区
                </h3>
                <div class="card blue-grey darken-1">
                    <div class="card-content blue-grey-text white">
                        <span class="card-title center">对战</span>
                        <div class="all-cards" style="display: none" id="user-cards">
                            <p class="center">
                                对方所有卡牌
                            </p>
                            <div id="cards">

                            </div>
                        </div>
                        <div id="select-request" style="display: block">
                            <p class="center">
                                请选择比赛对象.
                            </p>

                        </div>
                        <br>
                        <p class="center">
                            对战区域
                        </p>
                        <br />
                        <div class="" style="display: none">
                            <p class="center">等待对方决定</p>
                            <div class="progress">
                                <div class="indeterminate"></div>
                            </div>
                        </div>

                    </div>
                    <div class="card-action">
                        <div class="center">
                            <button class="btn waves-effect waves-light btn-medium cyan lighten-1" type="submit"
                                name="action">
                                开始
                                <i class="material-icons right">send</i>
                            </button>
                        </div>
                    </div>
                </div>
                <p id="now-user" class="center" style="display: none">

                </p>
            </div>

            <!-- register -->
            <div id="login-col" class="col s6" style="display: block">
                <h3 class="flow-text center blue-grey-text text-lighten-1">
                    登陆
                </h3>
                <div id="login-form" class="card blue-grey darken-1">
                    <div class="card-content blue-grey-text white">
                        <span class="card-title center">请输入你的名字: </span>
                        <br>
                        <!-- login form -->
                        <form class="cyan-text text-lighten-3">
                            <div class="input-field">
                                <input type="text" id="name">
                                <label for="name" class="active">你的名字</label>
                            </div>
                        </form>
                    </div>
                    <div class="card-action">
                        <div class="center">
                            <button class="btn waves-effect waves-light btn-medium cyan lighten-1" type="submit"
                                name="action" id="login">
                                登录
                                <i class="material-icons right">flight_takeoff</i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script>
        let userName = "";
        // var socket = io.connect('http://localhost:5000');
        var socket = io({'timeout': 5000, 'connect timeout': 5000});

        if (socket !== undefined) {
            console.log("connect to socket...");
        }

        socket.on("err", name => {
            if(name === userName){
                alert("用户已重名! \n若您已经登录, 则说明有用户在尝试用同样的名字登陆, 可不用理会.");
            }
        });

        const loginForm = document.getElementById("login-form");
        const loginCol = document.getElementById("login-col");
        const fightingArea = document.getElementById("fighting-area");
        const userList = document.getElementById("user-list");
        const nowUser = document.getElementById("now-user");
        const main = document.getElementById("main");
        const rank = document.getElementById("rank");

        //switch page
        document.getElementById("mainButton").onclick = function(){
            main.style = "display: block";
            rank.style = "display: none";
        }
        document.getElementById("rankButton").onclick = function(){
            main.style = "display: none";
            rank.style = "display: block";
        }
        //submit login form
        document.getElementById("login").onclick = function (e) {
            e.preventDefault();
            console.log("emit success!");
            userName = document.getElementById("name").value;
            //emit login user
            socket.emit('login', userName, () => {
                console.log("emit success!");
                loginCol.style = "display: none";
                fightingArea.style = "display: block";
                nowUser.textContent = `当前用户: ${userName}`;
                nowUser.style = "display: block";
                //add
            });
        };

        //update user list
        socket.on("loadUser", data => {
                console.log("initial ", data);
                const userList = document.getElementById("user-list");
                let users = data.users;
                let userCardsArray = data.userCards;
                console.log("userCardsArray", userCardsArray);
                let userCards = new Map(JSON.parse(userCardsArray));
                userList.innerHTML = "";

                users.forEach(user => {
                    var userLi = document.createElement("li");
                    
                    let cards = userCards.get(user);
                    console.log("selected array is ", cards);

                    if (cards.length == 0) {
                        console.log("no cards!");
                    } else {
                        userLi.setAttribute('class', "collection-item center");
                        userLi.setAttribute('style', "height: 170px;");
                        userLi.innerHTML =
                            `<div class="row" style="text-align:center">
                                <button id="${user}Button" class="btn waves-effect waves-light btn-medium cyan lighten-1 left z-depth-2">${user}</button>
                            </div>
                            <div class="center">
                                <span class="new badge cyan darken-2 z-depth-1 left" data-badge-caption="" style="margin-bottom: 1em">${cards[0]}</span>
                                <span class="new badge cyan darken-2 z-depth-1 left" data-badge-caption="" style="margin-bottom: 1em">${cards[1]}</span>
                                <span class="new badge cyan darken-2 z-depth-1 left" data-badge-caption="" style="margin-bottom: 1em">${cards[2]}</span>
                            </div>`;
                        userList.insertBefore(userLi, userList.lastChild);
                    }

                });
            });
    </script>
</body>

</html>